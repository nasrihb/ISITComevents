var mongoose = require('mongoose');
var user = require('config/Models/user');
var mongodb = require('mongodb');
var crypto = require('crypto');


var genRandomString = function(length){
  return crypto.randomBytes(Math.ceil(length/2)) //Nous utiliserons la fonction randomBytes de crypto pour générer une chaîne de caractères aléatoires qui sera utilisée comme sel.
      .toString('hex') //convertir au format hexadécimal 
      .slice(0,length); //retourne le nombre de caractères requis
};

// Hashing le mot de passe avec du sel
var sha512 = function(password,salt){
  var hash = crypto.createHmac('sha512', salt); //Crée un objet Hmac en utilisant l'algorithme SHA512 et la clé spécifiés salt
  hash.update(password);
  var value = hash.digest('hex');
  return {
    salt:salt,
    passwordHash:value
   };
};

function saltHashPassword(userPassword){
  var salt = genRandomString(16);//générer  une chaîne de caractères aléatoire de longeur 16
  var passwordData = sha512(userPassword,salt); // userpassword:mot de passe entré par l'utilisateur && salt : clé 
  return passwordData;
}

function checkHashPassword(userPassword,salt){
  var passwordData = sha512(userPassword,salt);
  return passwordData; }



exports.changephone = function(password,phone,email,callback)  {
    
var updateJson = {
              'tel':phone
            };

user.findOne({'email': email},function(err,users){

        var salt = users.salt; //get salt from user
        var hashed_password = checkHashPassword(password,salt).passwordHash;
        var encrypted_password = users.password; // get password from user if(encrypted_password == current_password)
        
        if(encrypted_password == hashed_password)
        {
           user.update({'email':email}, {$set: updateJson},function(err, users){ 
               if (err)  {
                  callback({'response':err});
               }
                   callback({'response':'Phone successfully updated'});
               });
        }
        else 
        {
        callback({'response':'Wrong Password','res':false});               
        }
      });  
}
